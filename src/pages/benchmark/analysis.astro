---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BenchmarkShell from '../../components/BenchmarkShell.astro';
import { agents, valueSystems } from '../../data/avbData';

const searchParams = Astro.url.searchParams;
const defaultSystem = valueSystems[0];
const selectedSystemId = searchParams.get('system') || defaultSystem.id;
const selectedSystem = valueSystems.find((system) => system.id === selectedSystemId) || defaultSystem;
const selectedDimensions = (searchParams.get('dims') || selectedSystem.dimensions.map((dim) => dim.id).join(','))
  .split(',')
  .filter(Boolean);

const defaultAgent = agents[0];
const selectedAgentId = searchParams.get('agent') || defaultAgent.id;
const selectedAgent = agents.find((agent) => agent.id === selectedAgentId) || defaultAgent;

const agentScores = selectedDimensions.length
  ? selectedDimensions.map((dimId) => ({
      id: dimId,
      name: selectedSystem.dimensions.find((dim) => dim.id === dimId)?.name || dimId,
      score: selectedAgent.scores[selectedSystem.id]?.[dimId] || 0
    }))
  : selectedSystem.dimensions.map((dim) => ({
      id: dim.id,
      name: dim.name,
      score: selectedAgent.scores[selectedSystem.id]?.[dim.id] || 0
    }));
---

<BaseLayout title="Analysis · Agent-ValueBench">
  <BenchmarkShell activeTab="analysis" title="Analysis" intro="Deep dive into a single agent. Inspect metadata, dimension scores, and evidence summaries to understand the alignment profile.">
    <section class="space-y-6">
      <div class="glass rounded-2xl p-6">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
          <div class="space-y-4">
            <div class="section-title">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-400/20 text-emerald-200">
                <svg viewBox="0 0 24 24" class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 3v18"></path>
                  <path d="M3 12h18"></path>
                </svg>
              </span>
              Agent profile
            </div>
            <div>
              <h2 class="text-3xl font-semibold text-white">{selectedAgent.name}</h2>
              <p class="text-sm text-slate-300">{selectedAgent.type} · {selectedAgent.developer}</p>
            </div>
            <div class="grid gap-3 text-sm text-slate-300 md:grid-cols-2">
              <div>
                <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Website</p>
                <a class="text-cyan-200" href={selectedAgent.website} target="_blank" rel="noreferrer">{selectedAgent.website}</a>
              </div>
              <div>
                <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Paper / report</p>
                <a class="text-cyan-200" href={selectedAgent.paper} target="_blank" rel="noreferrer">{selectedAgent.paper}</a>
              </div>
              <div>
                <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Release date</p>
                <p>{selectedAgent.releaseDate}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Measurement date</p>
                <p>{selectedAgent.measurementDate}</p>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3">
            <label class="text-xs uppercase tracking-[0.2em] text-slate-400">Select agent</label>
            <select class="rounded-2xl border border-white/10 bg-slate-950 px-4 py-3 text-sm text-white" data-agent-select>
              {agents.map((agent) => (
                <option value={agent.id} selected={agent.id === selectedAgent.id}>{agent.name}</option>
              ))}
            </select>
            <button class="rounded-full border border-white/10 px-4 py-2 text-xs uppercase tracking-[0.2em] text-slate-300">Download results</button>
          </div>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-lg font-semibold text-white">Dimension breakdown</p>
              <p class="text-sm text-slate-300">{selectedSystem.name} · {agentScores.length} dimensions selected</p>
            </div>
            <div class="rounded-full border border-white/10 px-3 py-1 text-xs uppercase tracking-[0.2em] text-slate-400">Bar chart</div>
          </div>
          <div class="mt-6 space-y-4">
            {agentScores.map((dim) => (
              <div>
                <div class="flex items-center justify-between text-sm text-slate-200">
                  <span>{dim.name}</span>
                  <span>{dim.score}</span>
                </div>
                <div class="mt-2 h-2 w-full rounded-full bg-slate-800">
                  <div class="h-full rounded-full bg-cyan-400" style={`width: ${dim.score}%;`}></div>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-lg font-semibold text-white">Radar overview</p>
              <p class="text-sm text-slate-300">Relative value footprint across selected dimensions.</p>
            </div>
            <div class="rounded-full border border-white/10 px-3 py-1 text-xs uppercase tracking-[0.2em] text-slate-400">Radar</div>
          </div>
          <div class="mt-6 flex items-center justify-center">
            <svg viewBox="0 0 300 300" class="h-64 w-64 text-cyan-300" data-radar>
              <circle cx="150" cy="150" r="120" fill="none" stroke="currentColor" opacity="0.2" />
              <circle cx="150" cy="150" r="80" fill="none" stroke="currentColor" opacity="0.2" />
              <circle cx="150" cy="150" r="40" fill="none" stroke="currentColor" opacity="0.2" />
              <polygon fill="rgba(34,211,238,0.25)" stroke="rgba(34,211,238,0.9)" stroke-width="2" data-radar-shape></polygon>
            </svg>
          </div>
        </div>
      </div>

      <div class="glass rounded-2xl p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-lg font-semibold text-white">Case evidence</p>
            <p class="text-sm text-slate-300">Placeholder summaries for qualitative grounding.</p>
          </div>
          <div class="rounded-full border border-white/10 px-3 py-1 text-xs uppercase tracking-[0.2em] text-slate-400">Coming soon</div>
        </div>
        <div class="mt-6 grid gap-4">
          {selectedAgent.cases.map((item) => (
            <div class="rounded-2xl border border-white/10 bg-slate-900/80 p-4">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                  <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Case score</p>
                  <p class="text-2xl font-semibold text-white">{item.score}</p>
                </div>
                <button class="rounded-full border border-white/10 px-4 py-2 text-xs uppercase tracking-[0.2em] text-slate-300" data-copy data-copy-text={`${item.question} ${item.summary}`}>Copy</button>
              </div>
              <div class="mt-4 text-sm text-slate-300">
                <p class="font-semibold text-white">Question</p>
                <p>{item.question}</p>
                <p class="mt-3 font-semibold text-white">Model stance / key points</p>
                <p>{item.summary}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  </BenchmarkShell>
</BaseLayout>

<script define:vars={{ selectedSystemId, selectedAgentId, agentScores }}>
  const agentSelect = document.querySelector('[data-agent-select]');
  agentSelect?.addEventListener('change', (event) => {
    const url = new URL(window.location.href);
    url.searchParams.set('agent', event.target.value);
    window.location.href = url.toString();
  });

  const radar = document.querySelector('[data-radar]');
  const radarShape = document.querySelector('[data-radar-shape]');
  if (radar && radarShape) {
    const center = 150;
    const radius = 110;
    const points = agentScores.map((item, index) => {
      const angle = (Math.PI * 2 * index) / agentScores.length - Math.PI / 2;
      const scaled = (item.score || 0) / 100;
      const x = center + Math.cos(angle) * radius * scaled;
      const y = center + Math.sin(angle) * radius * scaled;
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    });
    radarShape.setAttribute('points', points.join(' '));
  }

  document.querySelectorAll('[data-copy]').forEach((button) => {
    button.addEventListener('click', () => {
      const text = button.getAttribute('data-copy-text');
      if (text) {
        navigator.clipboard?.writeText(text);
        button.textContent = 'Copied';
        setTimeout(() => {
          button.textContent = 'Copy';
        }, 1200);
      }
    });
  });
</script>
